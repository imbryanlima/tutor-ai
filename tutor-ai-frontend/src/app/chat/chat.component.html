<div class="chat-page-container">
  <header class="chat-header">
    <h1><i class="pi pi-sparkles"></i> Tutor AI</h1>
    <p>Seu assistente pessoal de inglês</p>
  </header>

  <div class="message-list-wrapper" #messageListWrapper>
    <div class="message-list">
      <!-- Carregando histórico (quando não há cache) -->
      <ng-container *ngIf="estaCarregandoHistorico && mensagens.length === 0">
        <div class="message-loading">
          <p-skeleton width="60%" height="2rem" styleClass="mb-2"></p-skeleton>
          <p-skeleton width="45%" height="2rem" styleClass="mb-2"></p-skeleton>
          <p-skeleton width="70%" height="2rem"></p-skeleton>
        </div>
      </ng-container>

      <!-- Mensagens -->
      <div
        *ngFor="let msg of mensagens; trackBy: trackByIndex"
        class="message-bubble"
        [ngClass]="{ 'user-message': msg.autor === 'user', 'ia-message': msg.autor === 'ia' }"
      >
        <p>{{ msg.texto }}</p>

        <!-- Botão de áudio apenas para mensagens da IA -->
        <button
          *ngIf="msg.autor === 'ia'"
          pButton
          pRipple
          type="button"
          class="play-audio-btn"
          (click)="falar(msg.texto)"
        >
          <i class="pi" [ngClass]="isSpeaking ? 'pi-pause' : 'pi-play'"></i>
        </button>
      </div>

      <!-- Indicador de "IA digitando" -->
      <div *ngIf="estaCarregandoResposta" class="message-bubble ia-message typing-indicator">
        <p><span></span><span></span><span></span></p>
      </div>
    </div>

    <!-- Botão flutuante para descer até o final -->
    <button
      *ngIf="userAwayFromBottom"
      type="button"
      pButton
      pRipple
      class="scroll-bottom-btn"
      icon="pi pi-arrow-down"
      (click)="goToBottom()"
    ></button>
  </div>

  <div class="message-form-container">
    <form class="message-form" (ngSubmit)="enviarMensagem()">
      <textarea
        pTextarea
        [autoResize]="true"
        [(ngModel)]="novaMensagem"
        name="novaMensagem"
        placeholder="Pergunte algo ao Tutor AI..."
        rows="1"
        (keydown.enter)="onEnterKey($event)"
      >
      </textarea>

      <button
        pButton
        pRipple
        type="submit"
        [disabled]="!novaMensagem.trim() || estaCarregandoResposta"
        icon="pi pi-send"
        label=""
        class="send-button"
      ></button>
    </form>
  </div>
</div>
